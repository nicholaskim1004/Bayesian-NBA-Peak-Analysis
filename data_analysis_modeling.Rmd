---
title: "final_proj"
author: "Nick Kim"
date: "2025-11-27"
output: pdf_document
---

## Data Analysis

```{r}
nba <- read.csv("/Users/nicholaskim/Documents/STAT 551/final proj/Data/peaks.csv")

nba <- nba[,-1]
```


Making plots to help with setting priors

```{r}
library(ggplot2)
library(dplyr)

tier_order <- numeric(nrow(nba))

for (i in 1:nrow(nba)){
  if (nba$Player.Tier[i] == "All Time Great"){
    tier_order[i] = 1
  }
  else if (nba$Player.Tier[i] == "MVP"){
    tier_order[i] = 2
  }
  else if (nba$Player.Tier[i] == "All-NBA"){
    tier_order[i] = 3
  }
  else if (nba$Player.Tier[i] == "All-Star"){
    tier_order[i] = 4
  }
  else if (nba$Player.Tier[i] == "Good Starter"){
    tier_order[i] = 5
  }
  else if (nba$Player.Tier[i] == "Role Player"){
    tier_order[i] = 6
  }
  else if (nba$Player.Tier[i] == "Replacement Level"){
    tier_order[i] = 7
  }
  else{
    tier_order[i] = 8
  }
}

nba$Tier_ord <- tier_order

ggplot(data = nba, aes(x = Country, fill = reorder(Player.Tier,Tier_ord))) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(title = "Proportional Distribution of Tiers by Country",
       x = "Country",
       y = "Proportion",
       fill = "Tiers")

```
US, Spain, Turkey, France, and Serbia have very similar distributions with an even spread of players across tiers. An interesting thing to notice is that you only really see top talent (all-nba and above) coming from the countries with top leagues in the world.

```{r}
table(nba$Country)
```
Let's look at differences in leagues within a handful of countries we have data for
```{r}
usa <- subset(nba, Country == "USA")
spain <- subset(nba, Country == "Spain")

ggplot(data = usa, aes(x = reorder(League,League.Diff), fill = reorder(Player.Tier,Tier_ord))) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportional Distribution of Tiers by League in USA",
       x = "Leagues",
       y = "Proportion",
       fill = "Tiers")

print(table(usa$League))

ggplot(data = spain, aes(x = League, fill = reorder(Player.Tier,Tier_ord))) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(title = "Proportional Distribution of Tiers by League in Spain",
       x = "Leagues",
       y = "Proportion",
       fill = "Tiers")

print(table(spain$League))
```
For high school there is a selection bias in my data since the NBA stopped drafted high school players in the early 2000's and I pulled information on players who played up until 5 years ago. This means that those high school players who were significant contributors of had long successful careers where the ones that made it into my data while their other piers won't be captured.

In either case, the difference in leagues mostly seems to come in the number of all time great to all-nba talent that is produced.

```{r}
league_tier_plt <- ggplot(data = nba, aes(x = reorder(League, League.Diff), fill = reorder(Player.Tier,Tier_ord))) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportional Distribution of Tiers by League",
       x = "Leagues",
       y = "Proportion",
       fill = "Tiers")

ggsave("plots/league_tier_plt.png",league_tier_plt, width=10, height=7)

league_tier_plt
```

Lastly, lets take a look at draft position and its effect
```{r}
act_tier_prop_round <- ggplot(data = nba, aes(x = Round.Bin, fill = reorder(Player.Tier,Tier_ord))) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportional Distribution of Tiers by Round",
       x = "Pick Bin",
       y = "Proportion",
       fill = "Tiers")

ggsave("plots/tier_prop_round_act.png", act_tier_prop_round, height = 7, width = 10)

act_tier_prop_round

act_pick_prop_league <- ggplot(data = nba, aes(x = reorder(League, League.Diff), fill = Round.Bin)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportional Distribution of Pick Bin by League",
       x = "Leagues",
       y = "Proportion",
       fill = "Pick Bin")

ggsave("plots/pick_prop_league_act.png", act_pick_prop_league, height = 7, width = 10)

act_pick_prop_league

ggplot(data = usa, aes(x = reorder(League,League.Diff), fill = Round.Bin)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1) )+
  labs(title = "Proportional Distribution of Pick Bin by League in USA",
       x = "Leagues",
       y = "Proportion",
       fill = "Pick Bin")

ggplot(data = spain, aes(x = reorder(League,League.Diff), fill = Round.Bin)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportional Distribution of Pick Bin by League in Spain",
       x = "Leagues",
       y = "Proportion",
       fill = "Pick Bin")
```

Similar, to the other plots, as we move further away from places where we'd expect top talent less is produced. If we were to disregard the selection bias in high school we can see in the us bar charts that as league difficulty gets weaker there are a high proportion of Undrafted players. This is more clear in the Spain example, where high school is filtered out.


```{r warning=FALSE}
ggplot(nba, aes(x = Draft.Pick, color = League)) +
  geom_density(linewidth = 1, alpha = 0.5) +
  theme_bw()  +     # hide legend if too big
  labs(title = "Draft Pick Density per League",
       x = "Draft Pick",
       y = "Density")

```
Key insights:
- League difficulty matters in terms of generating elite/generational talent
- Same goes for Round.Bin 

These variables should then have their own effect to capture should differences

Looking at Bust rates
```{r}
print(prop.table(table(nba$Round.Bin,nba$Met.Draft.Expt)))
print(table(nba$Round.Bin,nba$Met.Draft.Expt))
```

Age of players across Round

```{r}
nba %>% select(Round.Bin, Age.Enter) %>% group_by(Round.Bin) %>% 
  summarise(mean_age = mean(Age.Enter),
            med_age = median(Age.Enter))
nba %>% select(Round.Bin, League, Age.Enter) %>% group_by(League, Round.Bin) %>% 
  summarise(mean_age = mean(Age.Enter),
            med_age = median(Age.Enter))
```


Age of Peaks

```{r}
print(mean(nba$Age.Peaked))
print(median(nba$Age.Peaked))
print(quantile(nba$Age.Peaked,c(.25,.75)))
```

From the ages we can see that younger players with more potential are picked earlier and generally they reach their peaks in the prime ages of their career of 22-26.

## Data Modeling

Adjusting League.Diff to be a scalar
```{r}
league_raw <- (30 + 1 - nba$League.Diff)  # invert so higher = more difficult
league_diff_std <- scale(league_raw)[,1] 

nba$League_adj <- league_diff_std
```


```{r}
num_leagues <- length(unique(nba$League))
num_pick_bins <- length(unique(nba$Round.Bin))
num_tiers <- length(unique(nba$Player.Tier))

tier_counts_table <- as.numeric(table(nba$League,nba$Round.Bin,nba$Player.Tier))
tier_counts <- array(tier_counts_table,dim = c(num_leagues,num_pick_bins,num_tiers))

league_diff_map <- nba %>% select(League, League_adj) %>% group_by(League) %>% summarise(league_adj= mean(League_adj))

league_diff_map$difficulty <- c(11,23,14,9,1,8,19,29,22,21,28,3,15,10,20,24,27,16,6,7,26,17,4,18,25,5,2,13)

dat = list(L = num_leagues,
           P = num_pick_bins,
           T = num_tiers,
           tier_counts = tier_counts,
           league_diff_map = league_diff_map$league_adj)
```

```{r}
library(rstan)
peaks_mcmc <- stan(
    file = "peak_hie.stan",
    data = dat,
    seed = 1234,
    chains = 4,
    iter = 10000
)
```

```{r}
summary_df <- as.data.frame(summary(peaks_mcmc)$summary)
```

```{r}
pp <- rstan::extract(peaks_mcmc)$prob_tier_new

rep_counts <- array(0, dim = c(nrow(pp), num_leagues, num_pick_bins, num_tiers))

for (i in 1:nrow(pp)){
  for (l in 1:num_leagues){
    for (p in 1:num_pick_bins){
      rep_counts[i, l, p, ] <- rmultinom(
        n = 1,
        size = total_lp[l, p],
        prob = pp[i, l, p, ]
      )
    }
  }
}
```

Let's see how our models player tier proportions are distributed compared to the data 
```{r}
#actual all time great rate from data
actual_league_atg_prop <- as.numeric(table(nba$League, nba$Player.Tier)[,1])/sum(as.numeric(table(nba$League, nba$Player.Tier)[,1]))


league_atg_prop = numeric(num_leagues)

for (l in 1:num_leagues){
  league_atg_count = apply(rep_counts[,l,,1],1,sum)
  total_atg_count = apply(rep_counts[,,,1],1,sum)
  
  league_atg_prop[l] = mean(league_atg_count/total_atg_count, na.rm = TRUE)
}

cat("Actual\n")
print(actual_league_atg_prop)
cat("Sim\n")
print(league_atg_prop)
```

```{r}
actual_league_atg_prop <- as.numeric(table(nba$League, nba$Player.Tier)[,1])/rowSums(table(nba$League, nba$Player.Tier))

sim_league_atg_prop <- numeric(num_leagues)

for (l in 1:num_leagues){
  atg_count_post   <- apply(rep_counts[,l,,1], 1, sum)
  total_count_post <- apply(rep_counts[,l,,],   1, sum)
  sim_league_atg_prop[l] <- mean(atg_count_post / total_count_post)
}

library(tidyverse)

df_plot <- tibble(
  League = factor(1:num_leagues, labels = as.numeric(rownames(league_diff_map))),
  Actual = actual_league_atg_prop,
  Sim    = sim_league_atg_prop
) %>%
  pivot_longer(cols = c(Actual, Sim),
               names_to = "Type", values_to = "Prop")

ggplot(df_plot, aes(x = League, y = Prop, fill = Type)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Actual vs Simulated ATG Rates by League",
       y = "All-Time-Great Rate",
       x = "League") +
  theme_minimal()

```

```{r}
actual_lp <- table(nba$League, nba$Round.Bin, nba$Player.Tier)[,,4]

sim_lp <- apply(rep_counts[,,,4], c(2,3), mean)

image(t(sim_lp))     # simulated heatmap
image(t(actual_lp))  # actual heatmap

```

Getting distribution of tiers by league on posterior samples. Hopefully it is somewhat comparable to the data we see

```{r}
all_tier_counts_per_league <- array(0, dim = c(num_leagues, num_tiers))
all_tier_counts_per_league <- matrix(0, nrow = num_leagues, ncol = num_tiers)

for (l in 1:num_leagues){
  for (t in 1:num_tiers){
    all_tier_counts_per_league[l,t] = sum(apply(rep_counts[,l,,t],1,sum))
  }
}

```

```{r}
df_plot <- tibble(
  League = c(rep("ABA",8),rep("BSL",8),rep("Bundesliga",8),rep("CBA",8),
             rep("Euroleague",8),rep("G League",8),rep("Greek B",8),
             rep("High School",8),rep("International Prep",8),
             rep("Israeli Premier League",8),rep("JUCO",8),rep("LKL",8),
             rep("LNB Pro A",8),rep("LNB Pro B",8),rep("LUB",8),
             rep("Liga ACB",8),rep("NBB",8),
             rep("NBL",8),rep("Nationale Masculine 1",8),rep("Other D1",8),
             rep("Overtime",8),rep("Primera FEB",8),rep("Serie A",8),
             rep("Serie B",8),rep("Super League 1",8),rep("Super Ligi",8),
             rep("Top D1",8),rep("VTB United League",8)),
  Tier = rep(c("All Time Great","All-NBA","All-Star","Benchwarmer","Good Starter","MVP","Replacement Level","Role Player"),28),
  Count = c(all_tier_counts_per_league[1,],all_tier_counts_per_league[2,],all_tier_counts_per_league[3,],all_tier_counts_per_league[4,],all_tier_counts_per_league[5,],all_tier_counts_per_league[6,],all_tier_counts_per_league[7,],all_tier_counts_per_league[8,],all_tier_counts_per_league[9,],all_tier_counts_per_league[10,],all_tier_counts_per_league[11,],all_tier_counts_per_league[12,],all_tier_counts_per_league[13,],all_tier_counts_per_league[14,],all_tier_counts_per_league[15,],all_tier_counts_per_league[16,],all_tier_counts_per_league[17,],all_tier_counts_per_league[18,],all_tier_counts_per_league[19,],all_tier_counts_per_league[20,],all_tier_counts_per_league[21,],all_tier_counts_per_league[22,],all_tier_counts_per_league[23,],all_tier_counts_per_league[24,],all_tier_counts_per_league[25,],all_tier_counts_per_league[26,],all_tier_counts_per_league[27,],all_tier_counts_per_league[28,]),
  League.Diff = c(rep(11,8),rep(23,8),rep(14,8),rep(9,8),rep(1,8),rep(8,8),rep(19,8),rep(29,8),rep(22,8),rep(21,8),rep(28,8),rep(3,8),rep(15,8),rep(10,8),rep(20,8),rep(24,8),rep(27,8),rep(16,8),rep(6,8),rep(7,8),rep(26,8),rep(17,8),rep(4,8),rep(18,8),rep(25,8),rep(5,8),rep(2,8),rep(13,8)),
  Tier_order = rep(c(1,3,4,8,5,2,7,6),28)
) 

tier_league_sim <- ggplot(df_plot, aes(x = reorder(League,League.Diff), y = Count, fill = reorder(Tier,Tier_order))) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Simulated Tier Rates by League",
       x = "League") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportional Distribution of Tiers by League from Posterior",
       x = "Leagues",
       y = "Proportion",
       fill = "Tier")

ggsave("plots/tier_prop_league_sim.png",tier_league_sim, width = 10, height = 7)

tier_league_sim
```


```{r}
tier_league_sim
```
Similar plot on round.  
```{r}
all_tier_counts_per_round <- matrix(0, nrow = num_pick_bins, ncol = num_tiers)

for (p in 1:num_pick_bins){
  for (t in 1:num_tiers){
    all_tier_counts_per_round[p,t] = sum(apply(rep_counts[,,p,t],1,sum))
  }
}

df_plot <- tibble(
  Pick_bin = c(rep("1-14",8),rep("15-30",8),rep("31-44",8),rep("45-60",8),
             rep("Undrafted",8)),
  Tier = rep(c("All Time Great","All-NBA","All-Star","Benchwarmer","Good Starter","MVP","Replacement Level","Role Player"),5),
  Count = c(all_tier_counts_per_round[1,],all_tier_counts_per_round[2,],all_tier_counts_per_round[3,],all_tier_counts_per_round[4,],all_tier_counts_per_round[5,]),
  Tier_order = rep(c(1,3,4,8,5,2,7,6),5)
) 

tier_prop_round <- ggplot(df_plot, aes(x = Pick_bin, y = Count, fill = reorder(Tier,Tier_order))) +
  geom_bar(stat = "identity", position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportional Distribution of Tiers by Pick Bin from Posterior",
       x = "Pick Bin",
       y = "Proportion",
       fill = "Tier")
 
 ggsave("plots/tier_prop_round_sim.png", tier_prop_round, height = 7, width = 10)
 tier_prop_round
```

Looking at dis of pick bin by league

```{r}
all_round_counts_per_league <- matrix(0, nrow = num_leagues, ncol = num_pick_bins)

for (l in 1:num_leagues){
  for (p in 1:num_pick_bins){
    all_round_counts_per_league[l,p] = sum(apply(rep_counts[,l,p,],1,sum))
  }
}

df_plot <- tibble(
  League = c(rep("ABA",5),rep("BSL",5),rep("Bundesliga",5),rep("CBA",5),
             rep("Euroleague",5),rep("G League",5),rep("Greek B",5),
             rep("High School",5),rep("International Prep",5),
             rep("Israeli Premier League",5),rep("JUCO",5),rep("LKL",5),
             rep("LNB Pro A",5),rep("LNB Pro B",5),rep("LUB",5),
             rep("Liga ACB",5),rep("NBB",5),
             rep("NBL",5),rep("Nationale Masculine 1",5),rep("Other D1",5),
             rep("Overtime",5),rep("Primera FEB",5),rep("Serie A",5),
             rep("Serie B",5),rep("Super League 1",5),rep("Super Ligi",5),
             rep("Top D1",5),rep("VTB United League",5)),
  Pick = rep(c("1-14","15-30","31-44","45-60","Undrafted"),28),
  Count = c(all_round_counts_per_league[1,],all_round_counts_per_league[2,],all_round_counts_per_league[3,],all_round_counts_per_league[4,],all_round_counts_per_league[5,],all_round_counts_per_league[6,],all_round_counts_per_league[7,],all_round_counts_per_league[8,],all_round_counts_per_league[9,],all_round_counts_per_league[10,],all_round_counts_per_league[11,],all_round_counts_per_league[12,],all_round_counts_per_league[13,],all_round_counts_per_league[14,],all_round_counts_per_league[15,],all_round_counts_per_league[16,],all_round_counts_per_league[17,],all_round_counts_per_league[18,],all_round_counts_per_league[19,],all_round_counts_per_league[20,],all_round_counts_per_league[21,],all_round_counts_per_league[22,],all_round_counts_per_league[23,],all_round_counts_per_league[24,],all_round_counts_per_league[25,],all_round_counts_per_league[26,],all_round_counts_per_league[27,],all_round_counts_per_league[28,]),
  League.Diff = c(rep(11,5),rep(23,5),rep(14,5),rep(9,5),rep(1,5),rep(8,5),rep(19,5),rep(29,5),rep(22,5),rep(21,5),rep(28,5),rep(3,5),rep(15,5),rep(10,5),rep(20,5),rep(24,5),rep(27,5),rep(16,5),rep(6,5),rep(7,5),rep(26,5),rep(17,5),rep(4,5),rep(18,5),rep(25,5),rep(5,5),rep(2,5),rep(13,5))
) 

sim_pick_prop_leauge <- ggplot(df_plot, aes(x = reorder(League,League.Diff), y = Count, fill = Pick)) +
  geom_bar(stat = "identity", position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportional Distribution of Pick by League from Posterior",
       x = "Leagues",
       y = "Proportion",
       fill = "Pick Bin")

ggsave("plots/pick_prop_league_sim.png", sim_pick_prop_leauge, height = 7, width = 10)

sim_pick_prop_leauge
```

## On NBA Draft Prospects


Creating NBA draft prospects data set. Some need to change college to one we have: Melbourne United, KK Partizan, Valencia Basket Club, South East Melbourne, Paris Basketball, Club Joventut, KK Mega
```{r}
nba_prospects <- data.frame(Player = c("AJ Dybantsa","Darryn Peterson","Cameron Boozer","Mikel Brown","Kingston Flemings","Caleb Wilson","Nate Ament","Karim Lopez","Isaiah Evans","Chris Cenac","Meleek Thomas","Labaron Philon","Dash Daniels","Cameron Carr","Hannes Steinbach","Brayden Burries","Darius Acuff","Matt Able","Thomas Haugh","Alijah Arenas","Yaxel Lendeborg","Bennett Stirtz","Patrick Ngongba","Ian Jackson","Tounde Yessoufou","Henri Vessaar","Miikka Muurinen","Koa Peat","Segio De Larrea","Miles Byrd","Zuby Ejiofor","Morez Johnson","JT Toppin","Karter Knox","PJ Haggerty","Adam Atamna","Richie Saunders","Baba Miller","Jaron Pierre","Tarris Reed","Nate Bittle","Malique Lewis","Milos Uzan","Baye Ndongo","Alex Karaban","Mouhamed Faye","Michael Ruzic","Mackenzie Mgbako","Tre White","Joshua Jefferson","Malique Ewin","Xaivian Lee","JJ Starling","Ognjen Srzentic","Braden Smith","Donovan Dent","Roddy Gayle","Kylan Boswell","Ryan Conwell","Denzel Aberdeen","Dame Sarr","Neoklis Avdalas","Flory Bidunga","Cayden Boozer","Chris Cenac Jr."),
           College = c("Brigham Young","Kansas","Duke","Louisville","Houston","North Carolina","Tennessee","New Zealand Breakers","Duke","Houston","Arkansas","Alabama","Melbourne United","Baylor","Washington","Arizona","Arkansas","North Carolina State","Florida","USC","Michigan","Iowa","Duke","St. John's","Baylor","North Carolina","KK Partizan","Arizona","Valencia Basket Club","San Diego State","St. John's","Michigan","Texas Tech","Arkansas","Kansas State","ASVEL","Brigham Young","Cincinnati","Southern Methodist","Connecticut","Oregon","South East Melbourne","Houston","Georgia Tech","Connecticut","Paris Basketball","Club Joventut Badalona","Texas A&M","Kansas","Iowa State","Arkansas","Florida","Syracuse","KK Mega Leks","Purdue","UCLA","Michigan","Illinois","Louisville","Kentucky","Duke","Virginia Tech","Kansas","Duke","Houston"),
           League = c(rep("Top D1",7),"NBL",rep("Top D1",4),"NBL",rep("Top D1",13),"Euroleague","Top D1","Liga ACB",rep("Top D1",6),"LNB Pro A",rep("Top D1",5),"NBL",rep("Top D1",3),"Euroleague","Liga ACB",rep("Top D1",6),"ABA",rep("Top D1",11)),
           Projected_pick = c(1:60,rep("Undrafted",5)),
           Proj_Round_bin = c(rep("1-14",15),rep("15-30",15),rep("31-44",15),rep("45-60",15),rep("Undrafted",5)))
```

Getting posterior draws for these prospects

```{r}
get_tier_probs <- function(pred_prob, leagues, pickbins, league_levels, pickbin_levels) {
  league_idx <- match(leagues, league_levels)
  pickbin_idx <- match(pickbins, pickbin_levels)
  
  player_tier_probs = matrix(0, nrow = length(league_idx), ncol = 8)
  
  for (i in 1:length(pickbin_idx)){
    probs <- pred_prob[, league_idx[i], pickbin_idx[i], ]
    player_tier_probs[i,] = colMeans(probs)
  }
  return(player_tier_probs)
}

tier_probs <- get_tier_probs(
  rep_counts,
  nba_prospects$League,
  nba_prospects$Proj_Round_bin,
  league_diff_map$League,
  c("1-14","15-30","31-44","45-60","Undrafted")
)
```


