---
title: "final_proj"
author: "Nick Kim"
date: "2025-11-27"
output: pdf_document
---

## Data Analysis

```{r}
nba <- read.csv("/Users/nicholaskim/Documents/STAT 551/final proj/Data/peaks.csv")

nba <- nba[,-1]
```


Making plots to help with setting priors

```{r}
library(ggplot2)
library(dplyr)

ggplot(data = nba, aes(x = Country, fill = Player.Tier)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
US, Spain, Turkey, France, and Serbia have very similar distributions with an even spread of players across tiers. An interesting thing to notice is that you only really see top talent (all-nba and above) coming from the countries with top leagues in the world.

```{r}
table(nba$Country)
```
Let's look at differences in leagues within a handful of countries we have data for
```{r}
usa <- subset(nba, Country == "USA")
spain <- subset(nba, Country == "Spain")

ggplot(data = usa, aes(x = League, fill = Player.Tier)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(table(usa$League))

ggplot(data = spain, aes(x = League, fill = Player.Tier)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(table(spain$League))
```
For high school there is a selection bias in my data since the NBA stopped drafted high school players in the early 2000's and I pulled information on players who played up until 5 years ago. This means that those high school players who were significant contributors of had long successful careers where the ones that made it into my data while their other piers won't be captured.

In either case, the difference in leagues mostly seems to come in the number of all time great to all-nba talent that is produced.

Lastly, lets take a look at draft position and its effect
```{r}
ggplot(data = nba, aes(x = Round.Bin, fill = Player.Tier)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data = nba, aes(x = reorder(League, League.Diff), fill = Round.Bin)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data = usa, aes(x = reorder(League,League.Diff), fill = Round.Bin)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data = spain, aes(x = reorder(League,League.Diff), fill = Round.Bin)) + 
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Similar, to the other plots, as we move further away from places where we'd expect top talent less is produced. If we were to disregard the selection bias in high school we can see in the us bar charts that as league difficulty gets weaker there are a high proportion of Undrafted players. This is more clear in the Spain example, where high school is filtered out.


```{r warning=FALSE}
ggplot(nba, aes(x = Draft.Pick, color = League)) +
  geom_density(linewidth = 1, alpha = 0.5) +
  theme_bw()  +     # hide legend if too big
  labs(title = "Draft Pick Density per League",
       x = "Draft Pick",
       y = "Density")

```
Key insights:
- League difficulty matters in terms of generating elite/generational talent
- Same goes for Round.Bin 

These variables should then have their own effect to capture should differences


## Data Modeling

High lvl idea: 

Layers: 
1. Country 19
2.College 285
3. Draft Pick Bin 5 each college
4. Player Impact (Superstar, Star, etc) 5 each bin

Distributions:

Global mu, std param -> 

use count data for countries to estimate concentration values to get probs of going to a college/team 




College Round Dis -> Categorical Distribution (based on n_i/t_i) where t_i is from Direchlet

Round Player Impact -> Bernoulli where props are determined by College and the Round selected

Creating per College dataset which I'll feed into my model. Player counts of each Round bin and Player Tier bins

```{r}
num_colleges = length(unique(nba$College))
num_round_bins = length(unique(nba$Round_bins))

round_prop_mat = matrix(nrow = num_colleges, ncol = num_round_bins)

for (i in 1:length(unique(nba$Round_bins))){
  round_prop_mat[,i] = pick_prop$total * pick_prop[,i+4, drop=TRUE]
}
colnames(round_prop_mat) <- c("Lottery","Late 1st","Early 2nd","Late 2nd","Undrafted")

round_totals <- rowSums(round_prop_mat)
```

Table for count of player tier given college and draft pick
```{r}
num_tiers = length(unique(player_grouping$Weight_Tier))
college_list = pick_prop$College

round_bins = c("1-14","15-30","31-44","45-60","Undrafted")

tier_mat = array(0,dim = list(num_colleges, num_round_bins, num_tiers))

for (i in 1:num_colleges){
  fil_to_col = prop_tiers_colleges_round[prop_tiers_colleges_round$College == college_list[i],]
    for (j in 1:num_round_bins){
      indx <- which(round_bins == fil_to_col$Round_bins[j])
      tier_mat[i,indx,] = as.numeric(fil_to_col[j,c(4,5,6,7,8),drop=TRUE]*fil_to_col[j,3,drop=TRUE])
    }
}
```

Setting up country vector in same order as others
```{r}
region <- merge(pick_prop[,1], unique(nba[,c(12,16)]), by = "College")
region_id_vec <- as.numeric(region$Country)
```

Running the STAN model
```{r}
library(rstan)

storage.mode(round_prop_mat) <- "integer"
storage.mode(tier_mat) <- "integer"

posterior <- stan(
  file = "by_college.stan",
  data = list(C = num_colleges, P = num_round_bins, T = num_tiers, R = length(unique(nba$Country)),
              region_of_college = region_id_vec, college_count = round_prop_mat, tier_count = tier_mat),
  seed = 1234,
  chains = 2,
  iter = 2000
)
```

```{r}
summary <- rstan::summary(posterior)$summary

summary(posterior)
```




posterior predictive check on a random subset of my data
```{r}
set.seed(1234)

n_samples <- 210

num_iters <- dim(post_picks)[1]
ran_iters <- sample(1:num_iters,n_samples)

pred_college_counts <- array(0,dim=list(n_samples, num_colleges, num_round_bins))
pred_tier_counts <- array(0,dim=list(n_samples, num_colleges, num_round_bins, num_tiers))

for (d in 1:n_samples){
  ran_ind = ran_iters[d]
  for (c in 1:num_colleges){
    Total_c = round_totals[c] #total number of players drafted from that college
    pred_college_counts[d,c,] = as.vector(rmultinom(1, size = Total_c, prob = post_picks[ran_ind,c,]))
    
    for (r in 1:num_round_bins){
      Total_t = sum(tier_mat[c,r,]) #total number of players drafted from that college and in that specific draft bin
      pred_tier_counts[d,c,r,] = as.vector(rmultinom(1, size = Total_t, prob = post_tiers[ran_ind,c,r,]))
    }
  }
}
```

Checking number of superstars betwen acutal data and from our simulated draw
```{r}
library(tidyverse)
actual_superstar_count <- apply(tier_mat[,,1],1,sum)

sim_superstar_count <- apply(pred_tier_counts[,,,1],c(1,2),sum)
  
sim_super_mean <- apply(sim_superstar_count, 2, mean)
sim_super_lo   <- apply(sim_superstar_count, 2, quantile, 0.05)
sim_super_hi   <- apply(sim_superstar_count, 2, quantile, 0.95)

ppc_df <- tibble(
  College = college_list,
  observed = actual_superstar_count,
  sim_mean = sim_super_mean,
  sim_lo = sim_super_lo,
  sim_hi = sim_super_hi
)

ppc_df %>% arrange(desc(observed)) %>% head(10)
```

```{r}
ggplot(ppc_df, aes(x = sim_mean, y = observed)) +
  geom_errorbarh(aes(xmin = sim_lo, xmax = sim_hi), height = 0.2, alpha = 0.6) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(title = "Variational Plot of Actual Superstar Count per College vs Sim",
       x = "Predicted # superstars (mean Â± 90% CI)", y = "Observed # superstars")
```
At lower tail where we have less data there is more variability/less certainty in capturing the observed superstar count. As we progress up the y axis or as we get more data we capture the true mean. Evidence that the model is plausible!


## On NBA Draft Prospects


Creating NBA draft prospects data set. Some need to change college to one we have: Melbourne United, KK Partizan, Valencia Basket Club, South East Melbourne, Paris Basketball, Club Joventut, KK Mega
```{r}
nba_prospects <- data.frame(Player = c("AJ Dybantsa","Darryn Peterson","Cameron Boozer","Mikel Brown","Kingston Flemings","Caleb Wilson","Nate Ament","Karim Lopez","Isaiah Evans","Chris Cenac","Meleek Thomas","Labaron Philon","Dash Daniels","Cameron Carr","Hannes Steinbach","Brayden Burries","Darius Acuff","Matt Able","Thomas Haugh","Alijah Arenas","Yaxel Lendeborg","Bennett Stirtz","Patrick Ngongba","Ian Jackson","Tounde Yessoufou","Henri Vessaar","Miikka Muurinen","Koa Peat","Segio De Larrea","Miles Byrd","Zuby Ejiofor","Morez Johnson","JT Toppin","Karter Knox","PJ Haggerty","Adam Atamna","Richie Saunders","Baba Miller","Jaron Pierre","Tarris Reed","Nate Bittle","Malique Lewis","Milos Uzan","Baye Ndongo","Alex Karaban","Mouhamed Faye","Michael Ruzic","Mackenzie Mgbako","Tre White","Joshua Jefferson","Malique Ewin","Xaivian Lee","JJ Starling","Ognjen Srzentic","Braden Smith","Donovan Dent","Roddy Gayle","Kylan Boswell","Ryan Conwell","Denzel Aberdeen","Dame Sarr","Neoklis Avdalas","Flory Bidunga","Cayden Boozer","Chris Cenac Jr."),
           College = c("Brigham Young","Kansas","Duke","Louisville","Houston","North Carolina","Tennessee","New Zealand Breakers","Duke","Houston","Arkansas","Alabama","Melbourne United","Baylor","Washington","Arizona","Arkansas","North Carolina State","Florida","USC","Michigan","Iowa","Duke","St. John's","Baylor","North Carolina","KK Partizan","Arizona","Valencia Basket Club","San Diego State","St. John's","Michigan","Texas Tech","Arkansas","Kansas State","ASVEL","Brigham Young","Cincinnati","Southern Methodist","Connecticut","Oregon","South East Melbourne","Houston","Georgia Tech","Connecticut","Paris Basketball","Club Joventut Badalona","Texas A&M","Kansas","Iowa State","Arkansas","Florida","Syracuse","KK Mega Leks","Purdue","UCLA","Michigan","Illinois","Louisville","Kentucky","Duke","Virginia Tech","Kansas","Duke","Houston"),
           Projected_pick = c(1:60,rep("Undrafted",5)))
```



