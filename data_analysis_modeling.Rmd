---
title: "final_proj"
author: "Nick Kim"
date: "2025-11-27"
output: pdf_document
---

## Data Analysis

```{r}
nba <- read.csv("/Users/nicholaskim/Documents/STAT 551/final proj/Data/Win_Shares_College_Draft.csv")

#removing first column as it stores the index of the data
nba <- nba[,-1]

#converting Draft.Picks into a numeric
nba$Draft.Pick <- as.numeric(nba$Draft.Pick)

#Since "Undrafted" will become NA will set this to be -5 to distinguish
nba$Draft.Pick[is.na(nba$Draft.Pick)] <- -5

#creating a factor on the type of draft pick they were 1st, 2nd, Undrafted
rounds = numeric(nrow(nba))
for (i in 1:nrow(nba)){
  if ((nba[i,13] <= 30) & (nba[i,13] > 0)){
    rounds[i] = "1st"
  }
  else if (nba[i,13]<= 0){
    rounds[i] = "Undrafted"
  }
  else{
    rounds[i] = "2nd"
  }
}

nba$Round <- as.factor(rounds)

round_bins = numeric(nrow(nba))
for (i in 1:nrow(nba)){
  if ((nba[i,13] <= 14) & (nba[i,13] > 0)){
    round_bins[i] = "1-14"
  }
  else if ((nba[i,13]> 14) & (nba[i,13] <= 30)) {
    round_bins[i] = "15-30"
  }
  else if ((nba[i,13]> 30) & (nba[i,13] <= 44)) {
    round_bins[i] = "31-44"
  }
  else if ((nba[i,13]> 44) & (nba[i,13] <= 60)) {
    round_bins[i] = "45-60"
  }
  else{
    round_bins[i] = "Undrafted"
  }
}

nba$Round_bins <- as.factor(round_bins)

#filling in missing info for 2 players
nba[nba$Player=="Sekou Doumbouya",12] <- "INSEP"
nba[nba$Player=="MÃ£ozinha Pereira",12] <- "Cearense"

#cleaning up College data
nba[nba$Player=="Alex Ducas",12] <- "Australian Institute of Sport"
nba[(nba$College == "St. John's, N.Y.")|(nba$College == "St. John's")|(nba$College == "St. John's (NY)"),12] <- "St. John's"
nba[(nba$College == "Sydney")|(nba$College == "Sydney Kings"),12]<-"Sydney"
nba[(nba$College == "Texas")|(nba$College == "University of Texas at Austin")|(nba$College == "Texas-Austin"),12] <- "Texas"
nba[(nba$College == "Wisc.-Green Bay")|(nba$College == "Wisconsin-Green Bay"),12] <- "Wisconsin-Green Bay"
nba[nba$Player=="Alex Sarr",12] <- "Perth"

#changing Undrafted player to be -5 for consistency
nba[nba$Player=="Scotty Hopson",13] <- -5
```
Lets see the different distributions of draft picks by college

```{r}
table(nba$College, nba$Round)
```

```{r}
library(dbplyr)

round_df <- as.data.frame(table(nba$College, nba$Round, nba$Round_bins))
colnames(round_df) <- c("College","Round","Round_bin","Count")

round_df <- round_df %>% arrange(desc(Count))
round_df %>% filter(Round == "1st") %>% slice_head(n=10)
```

This is showing the percentage that a player from that college will be a 1st, 2nd, or go Undrafted

```{r}
pick_prop <- round_df %>% group_by(College) %>% 
  summarise(total = sum(Count),
            prop_1st = sum(Count[Round == "1st"])/total,
            prop_2nd = sum(Count[Round == "2nd"])/total,
            prop_lottery = sum(Count[Round_bin == "1-14"])/total,
            prop_later1st = sum(Count[Round_bin == "15-30"])/total,
            prop_top2nd = sum(Count[Round_bin == "31-44"])/total,
            prop_later2nd = sum(Count[Round_bin == "45-60"])/total,
            prop_und = sum(Count[Round_bin == "Undrafted"])/total,
            prop_und = sum(Count[Round == "Undrafted"])/total)
pick_prop
```

Now lets look at how productive a player is from some draft position
```{r}
nba %>% group_by(Round) %>% 
  summarise(mean_WS = mean(WS),
            mean_BPM = mean(BPM),
            mean_PER = mean(PER))
```

Now with granular look by college
```{r}
WS_by_player_college <- nba %>%
  group_by(Player, College, Round_bins) %>%
  summarise(
    mean_WS  = mean(WS, na.rm = TRUE),
    mean_BPM = mean(BPM, na.rm = TRUE),
    mean_PER = mean(PER, na.rm = TRUE),
    .groups = "drop"
  )

```

```{r}
college_summary <- WS_by_player_college %>%
  group_by(College) %>%
  summarise(
    player_count = n(),                                 
    num_lottery = sum(Round_bins == "1-14"),
    num_late1st = sum(Round_bins == "15-30"),
    num_early2nd = sum(Round_bins == "31-44"),
    num_late2nd = sum(Round_bins == "45-60"),
    num_und = sum(Round_bins == "Undrafted"),
    
    avg_WS = mean(mean_WS),
    avg_BPM = mean(mean_BPM),
    avg_PER = mean(mean_PER),
    .groups = "drop"
  )

```

Let's also look at the percentage of star players to get more granularity!

Creating levels by the number of standard deviations away a players WS is by year. Will use an empicarl bayes shrinkage penalty on the number of MP so those who play more and are better are weighted fairly and those who did well with a small number of MP is less inflated. 

```{r}
k <- 1000
player_grouping <- nba %>%
  group_by(Year) %>%
  mutate(
    league_avg_WS48 = mean(WS.48, na.rm = TRUE),
    w = MP / (MP + k),
    adj_WS48 = w * WS.48 + (1 - w) * league_avg_WS48,
    weighted_WS = percent_rank(adj_WS48),
    Weight_Tier = case_when(
      weighted_WS >= 0.95 ~ "Superstar",
      weighted_WS >= 0.80 ~ "Star",
      weighted_WS >= 0.40 ~ "Role Player",
      weighted_WS >= 0.10 ~ "Bench",
      TRUE ~ "Non-Rotation"
    )
  )

```

Looking at frequency of superstar, star, etc for college
```{r}
player_unique <- player_grouping %>%
  distinct(Player, College, Weight_Tier)

tier_college <- player_unique %>%
  group_by(College) %>%
  summarise(
    n = n(),
    prop_superstar = mean(Weight_Tier == "Superstar"),
    prop_star = mean(Weight_Tier == "Star"),
    prop_role = mean(Weight_Tier == "Role Player"),
    prop_bench = mean(Weight_Tier == "Bench"),
    prop_non = mean(Weight_Tier == "Non-Rotation")
  )

#shrinkage pen for proportions

#getting global proportions
p0_superstar <- mean(player_unique$Weight_Tier == "Superstar")
p0_star <- mean(player_unique$Weight_Tier == "Star")
p0_role <- mean(player_unique$Weight_Tier == "Role Player")
p0_bench <- mean(player_unique$Weight_Tier == "Bench")
p0_non <- mean(player_unique$Weight_Tier == "Non-Rotation")

k <- 100   # shrinkage strength

tier_college <- tier_college %>%
  mutate(
    prop_superstar_shrunk = (n / (n + k)) * prop_superstar + 
                            (k / (n + k)) * p0_superstar,
    prop_star_shrunk = (n / (n + k)) * prop_star + 
                            (k / (n + k)) * p0_star,
    prop_role_shrunk = (n / (n + k)) * prop_role + 
                            (k / (n + k)) * p0_role,
    prop_bench_shrunk = (n / (n + k)) * prop_bench + 
                            (k / (n + k)) * p0_bench,
    prop_non_shrunk = (n / (n + k)) * prop_non + 
                            (k / (n + k)) * p0_non,
  )

```



```{r}
library(ggplot2)

ggplot(nba, aes(x = Draft.Pick, colour = Round_bins)) +
  geom_density()

ggplot(nba, aes(x = Draft.Pick)) +
  geom_density()
```

```{r warning=FALSE}
ggplot(nba, aes(x = Draft.Pick, color = College)) +
  geom_density(linewidth = 1, alpha = 0.5) +
  theme_bw() +
  theme(legend.position = "none") +     # hide legend if too big
  labs(title = "Draft Pick Density (All Colleges Overlaid)",
       x = "Draft Pick",
       y = "Density")

```
```{r}
library(tidyr)
library(dplyr)

tier_long <- tier_college %>%
  select(College, prop_superstar_shrunk, prop_star_shrunk, prop_role_shrunk, prop_bench_shrunk, prop_non_shrunk) %>%
  pivot_longer(
    cols = starts_with("prop_"),
    names_to = "Tier",
    values_to = "Scaled_Prop"
  ) %>%
  mutate(
    Tier = case_when(
      Tier == "prop_superstar_shrunk" ~ "Superstar",
      Tier == "prop_star_shrunk" ~ "Star",
      Tier == "prop_role_shrunk" ~ "Role Player",
      Tier == "prop_bench_shrunk" ~ "Bench",
      Tier == "prop_non_shrunk" ~ "Non-Rotation"
    )
  )

ggplot(tier_long, aes(x = College, y = Scaled_Prop, fill = Tier)) +
  geom_bar(stat = "identity", width = 1) +
  theme_bw() +
  labs(
    title = "Scaled Player Tier Proportions by College",
    x = "College",
    y = "Scaled Proportion"
  ) +
  scale_fill_manual(
    values = c(
      "Superstar" = "#FFD700",  # gold
      "Star" = "#1E90FF",       # dodger blue
      "Role Player" = "#32CD32",# lime green
      "Bench" = "#FFA500",      # orange
      "Non-Rotation" = "#A9A9A9"# dark grey
    )
  ) +
  theme(
    axis.text.x = element_text(size = 4, angle = 90, hjust = 1),
    legend.position = "right"
  )

```

```{r}
tier_long <- tier_college %>%
  select(College, prop_superstar, prop_star, prop_role, prop_bench, prop_non) %>%
  pivot_longer(
    cols = starts_with("prop_"),
    names_to = "Tier",
    values_to = "Scaled_Prop"
  ) %>%
  mutate(
    Tier = case_when(
      Tier == "prop_superstar" ~ "Superstar",
      Tier == "prop_star" ~ "Star",
      Tier == "prop_role" ~ "Role Player",
      Tier == "prop_bench" ~ "Bench",
      Tier == "prop_non" ~ "Non-Rotation"
    )
  )

ggplot(tier_long, aes(x = College, y = Scaled_Prop, fill = Tier)) +
  geom_bar(stat = "identity", width = 1) +
  theme_bw() +
  labs(
    title = "Scaled Player Tier Proportions by College",
    x = "College",
    y = "Scaled Proportion"
  ) +
  scale_fill_manual(
    values = c(
      "Superstar" = "#FFD700",  # gold
      "Star" = "#1E90FF",       # dodger blue
      "Role Player" = "#32CD32",# lime green
      "Bench" = "#FFA500",      # orange
      "Non-Rotation" = "#A9A9A9"# dark grey
    )
  ) +
  theme(
    axis.text.x = element_text(size = 4, angle = 90, hjust = 1),
    legend.position = "right"
  )

```

```{r}
prop_tiers_colleges_round <- player_grouping %>% group_by(College, Round_bins) %>% 
  summarise(
    n = n(),
    prop_superstar = mean(Weight_Tier == "Superstar"),
    prop_star = mean(Weight_Tier == "Star"),
    prop_role = mean(Weight_Tier == "Role Player"),
    prop_bench = mean(Weight_Tier == "Bench"),
    prop_non = mean(Weight_Tier == "Non-Rotation"),
    .groups = "drop"
  )
prop_tiers_colleges_round
```

## Data Modeling

High lvl idea: 

Layers: 
1. College -> Draft Pick
2. Draft Pick -> Player Impact (Superstar, Star, etc)

Distributions:
College Round Dis -> Categorical Distribution (based on n_i/t_i) where t_i is from Direchlet

Round Player Impact -> Bernoulli where props are determined by College and the Round selected

Creating per College dataset which I'll feed into my model. Player counts of each Round bin and Player Tier bins

```{r}
num_colleges = length(unique(nba$College))
num_round_bins = length(unique(nba$Round_bins))

round_prop_mat = matrix(nrow = num_colleges, ncol = num_round_bins)

for (i in 1:length(unique(nba$Round_bins))){
  round_prop_mat[,i] = pick_prop$total * pick_prop[,i+4, drop=TRUE]
}
colnames(round_prop_mat) <- c("Lottery","Late 1st","Early 2nd","Late 2nd","Undrafted")

round_totals <- rowSums(round_prop_mat)
```

Table for count of player tier given college and draft pick
```{r}
num_tiers = length(unique(player_grouping$Weight_Tier))
college_list = pick_prop$College

round_bins = c("1-14","15-30","31-44","45-60","Undrafted")

tier_mat = array(0,dim = list(num_colleges, num_round_bins, num_tiers))

for (i in 1:num_colleges){
  fil_to_col = prop_tiers_colleges_round[prop_tiers_colleges_round$College == college_list[i],]
    for (j in 1:num_round_bins){
      indx <- which(round_bins == fil_to_col$Round_bins[j])
      tier_mat[i,indx,] = as.numeric(fil_to_col[j,c(4,5,6,7,8),drop=TRUE]*fil_to_col[j,3,drop=TRUE])
    }
}
```

Running the STAN model
```{r}
library(rstan)

storage.mode(round_prop_mat) <- "integer"
storage.mode(tier_mat) <- "integer"

posterior <- stan(
  file = "by_college.stan",
  data = list(C = num_colleges, P = num_round_bins, T = num_tiers, college_count = round_prop_mat, tier_count = tier_mat),
  seed = 1234,
  chains = 2,
  iter = 2000
)
```
```{r}
summary <- rstan::summary(posterior)$summary

post_picks <- rstan::extract(posterior)$pick_probs
post_tiers <- rstan::extract(posterior)$tier_probs
```

posterior predictive check on a random subset of my data
```{r}
set.seed(1234)

n_samples <- 210

num_iters <- dim(post_picks)[1]
ran_iters <- sample(1:num_iters,n_samples)

pred_college_counts <- array(0,dim=list(n_samples, num_colleges, num_round_bins))
pred_tier_counts <- array(0,dim=list(n_samples, num_colleges, num_round_bins, num_tiers))

for (d in 1:n_samples){
  ran_ind = ran_iters[d]
  for (c in 1:num_colleges){
    Total_c = round_totals[c] #total number of players drafted from that college
    pred_college_counts[d,c,] = as.vector(rmultinom(1, size = Total_c, prob = post_picks[ran_ind,c,]))
    
    for (r in 1:num_round_bins){
      Total_t = sum(tier_mat[c,r,]) #total number of players drafted from that college and in that specific draft bin
      pred_tier_counts[d,c,r,] = as.vector(rmultinom(1, size = Total_t, prob = post_tiers[ran_ind,c,r,]))
    }
  }
}
```

Checking number of superstars betwen acutal data and from our simulated draw
```{r}
library(tidyverse)
actual_superstar_count <- apply(tier_mat[,,1],1,sum)

sim_superstar_count <- apply(pred_tier_counts[,,,1],c(1,2),sum)
  
sim_super_mean <- apply(sim_superstar_count, 2, mean)
sim_super_lo   <- apply(sim_superstar_count, 2, quantile, 0.05)
sim_super_hi   <- apply(sim_superstar_count, 2, quantile, 0.95)

ppc_df <- tibble(
  College = college_list,
  observed = actual_superstar_count,
  sim_mean = sim_super_mean,
  sim_lo = sim_super_lo,
  sim_hi = sim_super_hi
)

ppc_df %>% arrange(desc(observed)) %>% head(10)
```

